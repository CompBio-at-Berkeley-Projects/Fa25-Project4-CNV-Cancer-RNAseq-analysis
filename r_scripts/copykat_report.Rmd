---
title: "CopyKAT Analysis Report"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: cosmo
    highlight: tango
    code_folding: hide
    df_print: paged
params:
  sample_name: "sample"
  output_dir: "results"
  data: NULL
  result: NULL
  quality: NULL
  validation: NULL
  config: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)

# Load required packages
suppressPackageStartupMessages({
  library(knitr)
  library(ggplot2)
  library(pheatmap)
  library(RColorBrewer)
})

# Set ggplot2 theme
theme_set(theme_bw(base_size = 12))
```

# Executive Summary {.tabset}

## Overview

**Sample:** `r params$sample_name`
**Analysis Date:** `r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`
**Pipeline Version:** 1.0.0

This report presents the results of Copy Number Variation (CNV) analysis using CopyKAT (Copy number Karyotyping of Tumors) on single-cell RNA sequencing data.

## Key Findings

```{r key-findings}
if (!is.null(params$result)) {
  predictions <- params$result$prediction

  n_total <- nrow(predictions)
  n_aneuploid <- sum(predictions$copykat.pred == "aneuploid")
  n_diploid <- sum(predictions$copykat.pred == "diploid")
  pct_aneuploid <- round(n_aneuploid / n_total * 100, 2)

  mean_conf_aneu <- mean(predictions$copykat.confidence[predictions$copykat.pred == "aneuploid"])
  mean_conf_dip <- mean(predictions$copykat.confidence[predictions$copykat.pred == "diploid"])

  cat(sprintf("
- **Total Cells Analyzed:** %d
- **Aneuploid Cells:** %d (%.2f%%)
- **Diploid Cells:** %d (%.2f%%)
- **Mean Confidence (Aneuploid):** %.3f
- **Mean Confidence (Diploid):** %.3f
",
    n_total,
    n_aneuploid, pct_aneuploid,
    n_diploid, 100 - pct_aneuploid,
    mean_conf_aneu,
    mean_conf_dip
  ))
} else {
  cat("Analysis results not available.\n")
}
```

## Quality Assessment

```{r quality-assessment}
if (!is.null(params$quality)) {
  q <- params$quality

  status <- ifelse(q$genes_per_cell_median > 1000 &&
                   q$umi_per_cell_median > 2000,
                   "PASS", "WARNING")

  cat(sprintf("
**Overall Quality:** %s

**Metrics:**
- Median genes/cell: %d
- Median UMI/cell: %d
- Median cells/gene: %d
- Data sparsity: %.2f%%
",
    status,
    round(q$genes_per_cell_median),
    round(q$umi_per_cell_median),
    round(q$cells_per_gene_median),
    round(q$sparsity * 100, 2)
  ))

  if (!is.na(q$mt_percent_median)) {
    cat(sprintf("- Median mitochondrial %%: %.2f%%\n", q$mt_percent_median))
  }
}
```

---

# Data Quality Control

## Input Data Summary

```{r input-summary}
if (!is.null(params$validation)) {
  v <- params$validation

  data.frame(
    Metric = c("Number of Genes", "Number of Cells", "Data Sparsity"),
    Value = c(
      v$metrics$n_genes,
      v$metrics$n_cells,
      sprintf("%.2f%%", v$metrics$sparsity * 100)
    )
  ) %>% kable(caption = "Input Data Characteristics")
}

if (!is.null(params$data)) {
  cat(sprintf("\n**Matrix Dimensions:** %d genes Ã— %d cells\n",
              nrow(params$data), ncol(params$data)))
}
```

## Quality Control Metrics

```{r qc-plots, fig.width=12, fig.height=8}
if (!is.null(params$data)) {
  data <- params$data

  # Create QC metrics data frame
  genes_per_cell <- colSums(data > 0)
  umi_per_cell <- colSums(data)

  qc_df <- data.frame(
    cell = colnames(data),
    genes = genes_per_cell,
    umi = umi_per_cell,
    log_umi = log10(umi_per_cell + 1)
  )

  # Mitochondrial percentage
  mt_genes <- grep("^MT-|^mt-", rownames(data), value = TRUE)
  if (length(mt_genes) > 0) {
    qc_df$mt_percent <- colSums(data[mt_genes, , drop = FALSE]) / umi_per_cell * 100
  }

  # Plot genes per cell
  p1 <- ggplot(qc_df, aes(x = genes)) +
    geom_histogram(bins = 50, fill = "skyblue", color = "white") +
    geom_vline(xintercept = median(qc_df$genes), color = "red", linetype = "dashed", size = 1) +
    labs(title = "Genes Detected per Cell",
         x = "Number of Genes",
         y = "Number of Cells") +
    theme_minimal()

  # Plot UMI per cell
  p2 <- ggplot(qc_df, aes(x = log_umi)) +
    geom_histogram(bins = 50, fill = "lightgreen", color = "white") +
    geom_vline(xintercept = median(qc_df$log_umi), color = "red", linetype = "dashed", size = 1) +
    labs(title = "UMI per Cell (log10)",
         x = "log10(UMI + 1)",
         y = "Number of Cells") +
    theme_minimal()

  # Plot MT percentage if available
  if ("mt_percent" %in% colnames(qc_df)) {
    p3 <- ggplot(qc_df, aes(x = mt_percent)) +
      geom_histogram(bins = 50, fill = "plum", color = "white") +
      geom_vline(xintercept = 20, color = "red", linetype = "dashed", size = 1) +
      labs(title = "Mitochondrial Percentage",
           x = "MT %",
           y = "Number of Cells") +
      theme_minimal()

    gridExtra::grid.arrange(p1, p2, p3, ncol = 2)
  } else {
    gridExtra::grid.arrange(p1, p2, ncol = 2)
  }
}
```

```{r qc-summary-table}
if (!is.null(params$quality)) {
  q <- params$quality

  qc_summary <- data.frame(
    Metric = c(
      "Genes/Cell (Median)",
      "Genes/Cell (Mean)",
      "UMI/Cell (Median)",
      "UMI/Cell (Mean)",
      "Cells/Gene (Median)",
      "MT% (Median)",
      "Sparsity"
    ),
    Value = c(
      round(q$genes_per_cell_median, 0),
      round(q$genes_per_cell_mean, 0),
      round(q$umi_per_cell_median, 0),
      round(q$umi_per_cell_mean, 0),
      round(q$cells_per_gene_median, 0),
      ifelse(!is.na(q$mt_percent_median), sprintf("%.2f%%", q$mt_percent_median), "N/A"),
      sprintf("%.2f%%", q$sparsity * 100)
    )
  )

  kable(qc_summary, caption = "Quality Control Summary Statistics")
}
```

---

# CopyKAT Analysis Results

## Cell Classifications

```{r classification-summary}
if (!is.null(params$result)) {
  predictions <- params$result$prediction

  class_summary <- as.data.frame(table(predictions$copykat.pred))
  colnames(class_summary) <- c("Classification", "Count")
  class_summary$Percentage <- round(class_summary$Count / sum(class_summary$Count) * 100, 2)

  kable(class_summary, caption = "Cell Classification Summary")
}
```

```{r classification-plots, fig.width=12, fig.height=5}
if (!is.null(params$result)) {
  predictions <- params$result$prediction

  # Barplot of classifications
  p1 <- ggplot(predictions, aes(x = copykat.pred, fill = copykat.pred)) +
    geom_bar() +
    scale_fill_manual(values = c("aneuploid" = "coral", "diploid" = "skyblue")) +
    labs(title = "Cell Classification Distribution",
         x = "Classification",
         y = "Number of Cells") +
    theme_minimal() +
    theme(legend.position = "none")

  # Pie chart
  class_counts <- table(predictions$copykat.pred)
  pie_data <- data.frame(
    class = names(class_counts),
    count = as.numeric(class_counts),
    pct = round(as.numeric(class_counts) / sum(class_counts) * 100, 1)
  )

  p2 <- ggplot(pie_data, aes(x = "", y = count, fill = class)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y", start = 0) +
    scale_fill_manual(values = c("aneuploid" = "coral", "diploid" = "skyblue")) +
    labs(title = "Cell Type Distribution") +
    geom_text(aes(label = paste0(pct, "%")),
              position = position_stack(vjust = 0.5)) +
    theme_void()

  gridExtra::grid.arrange(p1, p2, ncol = 2)
}
```

## Confidence Scores

```{r confidence-analysis}
if (!is.null(params$result)) {
  predictions <- params$result$prediction

  conf_summary <- tapply(predictions$copykat.confidence,
                         predictions$copykat.pred,
                         function(x) c(Mean = mean(x),
                                       Median = median(x),
                                       SD = sd(x),
                                       Min = min(x),
                                       Max = max(x)))

  conf_df <- do.call(rbind, conf_summary)

  kable(round(conf_df, 3), caption = "Confidence Score Statistics by Classification")
}
```

```{r confidence-plots, fig.width=12, fig.height=5}
if (!is.null(params$result)) {
  predictions <- params$result$prediction

  # Histogram
  p1 <- ggplot(predictions, aes(x = copykat.confidence)) +
    geom_histogram(bins = 30, fill = "lightgreen", color = "white") +
    geom_vline(xintercept = 0.8, color = "red", linetype = "dashed", size = 1) +
    labs(title = "Confidence Score Distribution",
         x = "Confidence Score",
         y = "Number of Cells") +
    theme_minimal()

  # Boxplot by classification
  p2 <- ggplot(predictions, aes(x = copykat.pred, y = copykat.confidence, fill = copykat.pred)) +
    geom_boxplot() +
    scale_fill_manual(values = c("aneuploid" = "coral", "diploid" = "skyblue")) +
    labs(title = "Confidence by Classification",
         x = "Classification",
         y = "Confidence Score") +
    theme_minimal() +
    theme(legend.position = "none")

  gridExtra::grid.arrange(p1, p2, ncol = 2)
}
```

## CNV Heatmap

```{r cnv-heatmap, fig.width=12, fig.height=8}
# Display the CopyKAT-generated heatmap if available
heatmap_files <- list.files(params$output_dir, pattern = "_copykat_heatmap.pdf$", full.names = TRUE)

if (length(heatmap_files) > 0) {
  cat(sprintf("CNV heatmap available at: %s\n\n", heatmap_files[1]))
  cat("The heatmap shows:\n")
  cat("- Rows: Individual cells\n")
  cat("- Columns: Genomic positions across chromosomes\n")
  cat("- Colors: Red = amplification, Blue = deletion, White = neutral\n")
  cat("- Top cluster (white): Diploid cells\n")
  cat("- Bottom cluster (colored): Aneuploid cells with CNVs\n")
} else {
  cat("CNV heatmap not found in output directory.\n")
}
```

## Chromosome-Level Alterations

```{r chromosome-summary}
chr_summary_file <- file.path(params$output_dir, "chromosome_summary.csv")

if (file.exists(chr_summary_file)) {
  chr_summary <- read.csv(chr_summary_file)

  # Table
  kable(chr_summary, caption = "Mean Copy Number by Chromosome (Aneuploid Cells)")

  # Plot
  chr_summary$Chromosome <- factor(chr_summary$Chromosome,
                                    levels = chr_summary$Chromosome)

  ggplot(chr_summary, aes(x = Chromosome, y = Mean_CN, fill = Status)) +
    geom_bar(stat = "identity") +
    geom_hline(yintercept = 2, color = "red", linetype = "dashed", size = 1) +
    scale_fill_manual(values = c("Amplified" = "coral",
                                  "Deleted" = "skyblue",
                                  "Normal" = "gray80")) +
    labs(title = "Mean Copy Number by Chromosome",
         x = "Chromosome",
         y = "Mean Copy Number",
         caption = "Dashed line indicates diploid baseline (CN=2)") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

---

# Biological Interpretation

## Cancer Cell Fraction

```{r cancer-fraction}
if (!is.null(params$result)) {
  predictions <- params$result$prediction

  n_aneuploid <- sum(predictions$copykat.pred == "aneuploid")
  n_total <- nrow(predictions)
  cancer_frac <- round(n_aneuploid / n_total * 100, 2)

  cat(sprintf("
**Tumor Purity:** %.2f%%

This sample contains approximately %.0f%% cancer cells (aneuploid) and %.0f%% normal cells (diploid).

",
    cancer_frac,
    cancer_frac,
    100 - cancer_frac
  ))

  if (cancer_frac > 80) {
    cat("High tumor purity suggests a predominantly malignant sample.\n")
  } else if (cancer_frac > 50) {
    cat("Moderate tumor purity indicates a mixed sample with both tumor and stromal/immune cells.\n")
  } else if (cancer_frac > 20) {
    cat("Low tumor purity suggests significant contamination with normal cells.\n")
  } else {
    cat("Very low tumor purity. Verify sample composition.\n")
  }
}
```

## CNV Patterns

```{r cnv-interpretation}
chr_summary_file <- file.path(params$output_dir, "chromosome_summary.csv")

if (file.exists(chr_summary_file)) {
  chr_summary <- read.csv(chr_summary_file)

  amplified <- chr_summary$Chromosome[chr_summary$Status == "Amplified"]
  deleted <- chr_summary$Chromosome[chr_summary$Status == "Deleted"]

  cat("**Detected Chromosomal Alterations:**\n\n")

  if (length(amplified) > 0) {
    cat(sprintf("- **Amplifications:** %s\n", paste(amplified, collapse = ", ")))
  }

  if (length(deleted) > 0) {
    cat(sprintf("- **Deletions:** %s\n", paste(deleted, collapse = ", ")))
  }

  if (length(amplified) == 0 && length(deleted) == 0) {
    cat("No significant chromosome-level alterations detected.\n")
  }

  cat("\n**Clinical Relevance:**\n\n")
  cat("Common cancer-associated CNVs include:\n")
  cat("- Chr7 gain: EGFR amplification (glioblastoma)\n")
  cat("- Chr10 loss: PTEN deletion (glioblastoma)\n")
  cat("- Chr8q gain: MYC amplification (various cancers)\n")
  cat("- Chr17p loss: TP53 deletion (various cancers)\n")
}
```

---

# Methods

## Analysis Parameters

```{r methods-params}
if (!is.null(params$config)) {
  config <- params$config

  params_table <- data.frame(
    Parameter = c(
      "Genome Build",
      "Gene ID Type",
      "Cell Line",
      "Min Genes/Chr",
      "LOW.DR",
      "UP.DR",
      "Window Size",
      "KS Cut",
      "Distance Metric",
      "CPU Cores"
    ),
    Value = c(
      config$copykat$genome,
      config$copykat$id_type,
      config$copykat$cell_line,
      config$copykat$ngene_chr,
      config$copykat$LOW_DR,
      config$copykat$UP_DR,
      config$copykat$win_size,
      config$copykat$KS_cut,
      config$copykat$distance,
      config$copykat$n_cores
    )
  )

  kable(params_table, caption = "CopyKAT Analysis Parameters")
}
```

## Algorithm Summary

CopyKAT (Copy number Karyotyping of Tumors) infers copy number variations from single-cell RNA sequencing data through the following steps:

1. **Data Preprocessing**: Gene filtering based on detection rate thresholds
2. **Normalization**: Freeman-Tukey transformation for variance stabilization
3. **Smoothing**: Dynamic Linear Model (DLM) for chromosomal smoothing
4. **Baseline Estimation**: Gaussian Mixture Model to identify diploid cells
5. **Segmentation**: Bayesian segmentation with Kolmogorov-Smirnov test
6. **Classification**: Hierarchical clustering to separate aneuploid from diploid cells

**Reference:** Gao et al. (2021). "Delineating copy number and clonal substructure in human tumors from single-cell transcriptomes." Nature Biotechnology.

---

# Quality Control Checks

```{r qc-checks}
qc_checks <- data.frame(
  Check = character(),
  Status = character(),
  Details = character(),
  stringsAsFactors = FALSE
)

if (!is.null(params$quality)) {
  q <- params$quality

  # Check 1: Sufficient genes per cell
  genes_status <- ifelse(q$genes_per_cell_median >= 1000, "PASS", "WARNING")
  qc_checks <- rbind(qc_checks, data.frame(
    Check = "Genes per Cell",
    Status = genes_status,
    Details = sprintf("Median: %d (recommended >1000)", round(q$genes_per_cell_median))
  ))

  # Check 2: Sufficient UMI per cell
  umi_status <- ifelse(q$umi_per_cell_median >= 2000, "PASS", "WARNING")
  qc_checks <- rbind(qc_checks, data.frame(
    Check = "UMI per Cell",
    Status = umi_status,
    Details = sprintf("Median: %d (recommended >2000)", round(q$umi_per_cell_median))
  ))

  # Check 3: MT percentage
  if (!is.na(q$mt_percent_median)) {
    mt_status <- ifelse(q$mt_percent_median <= 20, "PASS", "WARNING")
    qc_checks <- rbind(qc_checks, data.frame(
      Check = "Mitochondrial %",
      Status = mt_status,
      Details = sprintf("Median: %.2f%% (recommended <20%%)", q$mt_percent_median)
    ))
  }
}

if (!is.null(params$result)) {
  predictions <- params$result$prediction

  # Check 4: Confidence scores
  mean_conf <- mean(predictions$copykat.confidence)
  conf_status <- ifelse(mean_conf >= 0.8, "PASS", "WARNING")
  qc_checks <- rbind(qc_checks, data.frame(
    Check = "Classification Confidence",
    Status = conf_status,
    Details = sprintf("Mean: %.3f (recommended >0.80)", mean_conf)
  ))

  # Check 5: Cell count
  n_cells <- nrow(predictions)
  cell_status <- ifelse(n_cells >= 100, "PASS", "WARNING")
  qc_checks <- rbind(qc_checks, data.frame(
    Check = "Cell Count",
    Status = cell_status,
    Details = sprintf("N=%d (recommended >100)", n_cells)
  ))
}

kable(qc_checks, caption = "Quality Control Checklist")
```

---

# Session Information

```{r session-info}
sessionInfo()
```

---

# Output Files

The following files were generated during this analysis:

```{r output-files}
output_files <- list.files(params$output_dir, recursive = TRUE)

if (length(output_files) > 0) {
  # Group by type
  predictions <- grep("prediction", output_files, value = TRUE)
  cnv_results <- grep("CNA.*results", output_files, value = TRUE)
  plots <- grep("\\.pdf$|\\.png$", output_files, value = TRUE)
  csvs <- grep("\\.csv$", output_files, value = TRUE)
  logs <- grep("log", output_files, value = TRUE)

  cat("**Predictions:**\n")
  if (length(predictions) > 0) {
    for (f in predictions) cat(sprintf("- %s\n", f))
  }

  cat("\n**CNV Results:**\n")
  if (length(cnv_results) > 0) {
    for (f in cnv_results) cat(sprintf("- %s\n", f))
  }

  cat("\n**Visualizations:**\n")
  if (length(plots) > 0) {
    for (f in plots) cat(sprintf("- %s\n", f))
  }

  cat("\n**CSV Exports:**\n")
  if (length(csvs) > 0) {
    for (f in csvs) cat(sprintf("- %s\n", f))
  }

  cat("\n**Logs:**\n")
  if (length(logs) > 0) {
    for (f in logs) cat(sprintf("- %s\n", f))
  }
}
```

---

**Report generated:** `r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`
**CopyKAT Pipeline Version:** 1.0.0
